events {
    worker_connections 1024;
}

http {
    upstream pgadmin {
        server pgadmin:80;
    }
    
    upstream openwebui {
        server open-webui:8080;
    }
    
    upstream tinybert {
        server tinybert:8083;
    }
    
    upstream ollama {
        server ollama:11434;
    }

    # Main HTTP Server - Tailscale friendly
    server {
        listen 80;
        server_name _;
        
        # Allow Tailscale network
        allow 100.64.0.0/10;  # Tailscale CGNAT range
        allow 172.20.0.0/16;  # Docker network
        allow 127.0.0.0/8;    # Localhost
        allow 192.168.0.0/16; # Local network
        allow 10.0.0.0/8;     # Local network
        deny all;

        # Default location - service selector
        location / {
            return 200 "
PostgresAI Services:
- pgAdmin: /pgadmin/
- OpenWebUI: /webui/
- TinyBERT: /tinybert/
- Ollama API: /ollama/

Direct Access (via Tailscale IP 100.116.98.41):
- PostgreSQL: 100.116.98.41:65432
- pgAdmin: http://100.116.98.41:5051
- DBeaver: http://100.116.98.41:8978
- OpenWebUI: http://100.116.98.41:8081
- TinyBERT: http://100.116.98.41:8083
";
            add_header Content-Type text/plain;
        }

        # pgAdmin proxy
        location /pgadmin/ {
            proxy_pass http://pgadmin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Script-Name /pgadmin;
        }

        # OpenWebUI proxy
        location /webui/ {
            proxy_pass http://openwebui/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # TinyBERT proxy
        location /tinybert/ {
            proxy_pass http://tinybert/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Ollama API proxy
        location /ollama/ {
            proxy_pass http://ollama/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
